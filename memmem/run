#!/bin/sh
BENCH_FN=memmem
for I in ${BENCH_FN}_*.c; do
  gcc $I -O3 -fPIC -shared -o tmp/lib$I.so
  ln -s -f tmp/lib$I.so lib${BENCH_FN}.so
  gcc -L. tester.c -o tester -l${BENCH_FN} -lm -g
done
gcc ts_avg.c
./a.out

comp(){
  echo $1 > tmp/result_$1
  ln -s -f tmp/lib$1.so lib${BENCH_FN}.so
  LD_LIBRARY_PATH=. ./tester $2 $3 $4 $5>> tmp/result_$1 2> tmp/output_$1
  cp plot.dat  data/${1}_$GNAME.dat
  cp plot_r.dat data/${1}_$GNAME_r.dat
  if [ -e tmp/output ] ; then
    diff -u tmp/output_$1 tmp/output
  fi
  cp tmp/output_$1 tmp/output
}
html_a(){
  echo $* >>html/${BENCH_FN}.html
}
html_r(){
  echo $* >>html/${BENCH_FN}_r.html
}
html(){
  html_a $*
  html_r $*
}

draw(){
  for I in ${BENCH_FN}_*.c; do
    comp $I $1 $2 $3 $4
  done 
  echo reset > tmp/plot.gp
  echo set terminal png >> tmp/plot.gp
  echo set xlabel "'haystack size'" >> tmp/plot.gp
  echo set ylabel "'instructions'" >> tmp/plot.gp
  echo "plot \\" >> tmp/plot.gp

  echo reset > tmp/plot_r.gp
  echo set terminal png >> tmp/plot_r.gp
  echo set xlabel "'haystack size'" >> tmp/plot_r.gp
  echo set ylabel "'instructions per character'" >> tmp/plot_r.gp
  echo "plot \\" >> tmp/plot_r.gp

  rm -f tmp/output

  for I in ${BENCH_FN}_*.c; do
    echo "\"data/${I}_$GNAME.dat\" using 1:2 with lines title '$I', \\" >> tmp/plot.gp
    echo "\"data/${I}_$GNAME_r.dat\" using 1:2 with lines title '$I', \\" >> tmp/plot_r.gp
  done
  echo 0 >> tmp/plot.gp
  echo 0 >> tmp/plot_r.gp
  gnuplot tmp/plot.gp > html/$GNAME.png
  chmod a+r html/$GNAME.png
  gnuplot tmp/plot_r.gp > html/$GNAME_r.png
  chmod a+r html/$GNAME_r.png
}

echo "<html><body style=\"width:1000%;\"><table>" > html/${BENCH_FN}.html
chmod a+r html/${BENCH_FN}.html
echo "<html><body style=\"width:1000%;\"><table>" > html/${BENCH_FN}_r.html
chmod a+r html/${BENCH_FN}_r.html
export N=1
try(){
  html "<tr><td>*_$1_*_$3_$4_${ALIGNED}</td>"
  for NO in 1 10 100 1000 10000; do
    export GNAME="$1_${NO}_$3_$4_${ALIGNED}"
    export GNAME_r="$1_${NO}_$3_$4_${ALIGNED}_r"
    html_a "<td><img src='$GNAME.png'></img></td>"
    html_r "<td><img src='$GNAME_r.png'></img></td>"
  done
  html "</tr>"
}

. ./benchmark

try(){
  export GNAME="$1_$2_$3_$4_${ALIGNED}"
  export GNAME_r="$1_$2_$3_$4_${ALIGNED}_r"
  echo $GNAME
  draw $1 $2 $3 $4
}
for NO in 1 10 100 1000 10000; do
  export N=$NO
  . ./benchmark
done


html "</table><pre>"
cat /proc/cpuinfo >> html/${BENCH_FN}.html
cat /proc/cpuinfo >> html/${BENCH_FN}_r.html
html "</pre></body></html>" 
